<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="ir_mis_total_loan_member_crosstab" language="groovy" printOrder="Horizontal" pageWidth="1000" pageHeight="595" orientation="Landscape" columnWidth="960" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="78f52c7e-6c90-4408-8b4f-857481898b8b">
	<property name="ireport.zoom" value="0.9090909090909094"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="Crosstab Data Text" hAlign="Center"/>
	<parameter name="as_coopid" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="adtm_date" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="period_age" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="status" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT lt.loantype_code
	, lt.loantype_desc
	, case when nvl(m.province_code, '000') = '000' then '999' else m.province_code end  AS province_code
	, mp.province_desc
	, pa.group_code
	, pa.group_desc
	, mf.member_flag
	, mf.member_desc
	, count(CASE WHEN TRUNC(ft_calage(m.BIRTH_DATE, TRUNC($P{adtm_date}), 8) / 12) BETWEEN pa.from_age AND pa.to_age
				AND mf.member_flag = (CASE WHEN m.member_status = 1 AND m.resign_status = 0 THEN 0 ELSE 1 END) THEN 1 ELSE NULL END) as member_cnt
	, cm.coop_name
FROM LNCONTSTATEMENT l
JOIN (
	SELECT LOANCONTRACT_NO, MAX(seq_no) AS seq_no FROM LNCONTSTATEMENT
	WHERE OPERATE_DATE <= $P{adtm_date}
		AND ITEM_STATUS = 1 AND LOANITEMTYPE_CODE <> 'CL'
	GROUP BY LOANCONTRACT_NO
) lq ON l.loancontract_no = lq.loancontract_no
	AND l.seq_no = lq.seq_no
JOIN LNCONTMASTER lm ON l.loancontract_no = lm.loancontract_no
JOIN LNLOANTYPE lt ON lm.loantype_code = lt.loantype_code
JOIN MBMEMBMASTER m ON lm.member_no = m.member_no
LEFT JOIN MBUCFPROVINCE mp ON nvl(m.province_code, '000') = mp.province_code
JOIN CMCOOPCONSTANT cm ON lm.COOP_ID = cm.COOP_ID
CROSS JOIN (
SELECT LEVEL AS group_code
	, TO_CHAR(0+ ($P{period_age} * (LEVEL - 1))+ CASE WHEN LEVEL = 1 THEN 0 ELSE 1 END) || ' - ' || TO_CHAR(0 + ($P{period_age} * LEVEL)) AS group_desc
	, 0 + ($P{period_age} * (LEVEL - 1)) + CASE WHEN LEVEL = 1 THEN 0 ELSE 1 END AS from_Age, 0 + ($P{period_age} * LEVEL) AS to_age
FROM dual CONNECT BY LEVEL <= (
	SELECT CEIL(TRUNC((MAX(ft_calage(m.BIRTH_DATE, TRUNC($P{adtm_date}), 4)))) / $P{period_age}) AS ages
	FROM MBMEMBMASTER m
)) pa
CROSS JOIN (
	SELECT LEVEL - 1 AS member_flag, CASE WHEN LEVEL = 1 THEN 'ปกติ' ELSE 'พ้นสภาพ' END AS member_desc
	FROM dual CONNECT BY LEVEL <= 2
) mf
WHERE l.principal_balance > 0
and (CASE WHEN m.member_status = 1 AND m.resign_status = 0 THEN 0 ELSE 1 END) like $P{status}
GROUP BY lt.loantype_code
	, lt.loantype_desc
	, case when nvl(m.province_code, '000') = '000' then '999' else m.province_code end
	, mp.province_desc
	, pa.group_code
	, pa.group_desc
	, cm.coop_name
	, mf.member_flag
	, mf.member_desc
ORDER BY province_code , loantype_code, member_flag, pa.group_code]]>
	</queryString>
	<field name="LOANTYPE_CODE" class="java.lang.String"/>
	<field name="LOANTYPE_DESC" class="java.lang.String"/>
	<field name="PROVINCE_CODE" class="java.lang.String"/>
	<field name="PROVINCE_DESC" class="java.lang.String"/>
	<field name="GROUP_CODE" class="java.math.BigDecimal"/>
	<field name="GROUP_DESC" class="java.lang.String"/>
	<field name="MEMBER_FLAG" class="java.math.BigDecimal"/>
	<field name="MEMBER_DESC" class="java.lang.String"/>
	<field name="MEMBER_CNT" class="java.math.BigDecimal"/>
	<field name="COOP_NAME" class="java.lang.String"/>
	<variable name="ages_member_cnt" class="java.math.BigDecimal" resetType="Group" resetGroup="ages" calculation="Sum">
		<variableExpression><![CDATA[$F{MEMBER_CNT}]]></variableExpression>
	</variable>
	<variable name="province_member_cnt" class="java.math.BigDecimal" resetType="Group" resetGroup="province" calculation="Sum">
		<variableExpression><![CDATA[$F{MEMBER_CNT}]]></variableExpression>
	</variable>
	<variable name="status_member_cnt" class="java.math.BigDecimal" resetType="Group" resetGroup="status" calculation="Sum">
		<variableExpression><![CDATA[$F{MEMBER_CNT}]]></variableExpression>
	</variable>
	<variable name="member_cnt" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{MEMBER_CNT}]]></variableExpression>
	</variable>
	<group name="province">
		<groupExpression><![CDATA[$F{PROVINCE_CODE}]]></groupExpression>
		<groupFooter>
			<band height="164">
				<textField>
					<reportElement uuid="cccda365-6089-44e4-abb2-0498abb0e2f4" isPrintRepeatedValues="false" x="0" y="0" width="960" height="20" isPrintInFirstWholeBand="true"/>
					<textElement verticalAlignment="Middle">
						<font fontName="Angsana New" size="14"/>
						<paragraph leftIndent="5"/>
					</textElement>
					<textFieldExpression><![CDATA["จังหวัด : " + ($F{PROVINCE_DESC} == null ? "ไม่ได้ระบุ" : $F{PROVINCE_DESC} )]]></textFieldExpression>
				</textField>
				<crosstab>
					<reportElement uuid="7179e7d8-207a-4c0b-8346-2fe3458d8f01" x="0" y="20" width="960" height="144"/>
					<crosstabDataset isDataPreSorted="true">
						<dataset resetType="Group" resetGroup="province"/>
					</crosstabDataset>
					<crosstabHeaderCell>
						<cellContents>
							<staticText>
								<reportElement uuid="4ff479f0-7bc9-475a-8323-c277eca5b76d" style="Crosstab Data Text" x="0" y="0" width="140" height="20"/>
								<box>
									<pen lineWidth="0.5"/>
									<topPen lineWidth="0.5"/>
									<leftPen lineWidth="0.5"/>
									<bottomPen lineWidth="0.5"/>
									<rightPen lineWidth="0.5"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Angsana New" size="14"/>
								</textElement>
								<text><![CDATA[ประเภท]]></text>
							</staticText>
							<staticText>
								<reportElement uuid="4084e7f3-2a41-4582-a516-c8f1fa3c4725" style="Crosstab Data Text" x="140" y="0" width="70" height="20"/>
								<box>
									<pen lineWidth="0.5"/>
									<topPen lineWidth="0.5"/>
									<leftPen lineWidth="0.5"/>
									<bottomPen lineWidth="0.5"/>
									<rightPen lineWidth="0.5"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Angsana New" size="14"/>
								</textElement>
								<text><![CDATA[สถานภาพ]]></text>
							</staticText>
						</cellContents>
					</crosstabHeaderCell>
					<rowGroup name="LOANTYPE_CODE" width="140" totalPosition="End">
						<bucket class="java.lang.String">
							<bucketExpression><![CDATA[$F{LOANTYPE_CODE} + $F{LOANTYPE_DESC}]]></bucketExpression>
						</bucket>
						<crosstabRowHeader>
							<cellContents backcolor="#FFFFFF" mode="Transparent">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<textField>
									<reportElement uuid="19be54d5-bdba-4332-b432-a3913dd9f6e7" x="0" y="0" width="140" height="40"/>
									<textElement verticalAlignment="Top">
										<font fontName="Angsana New" size="14"/>
										<paragraph leftIndent="2"/>
									</textElement>
									<textFieldExpression><![CDATA[$V{LOANTYPE_CODE}.substring(2)]]></textFieldExpression>
								</textField>
							</cellContents>
						</crosstabRowHeader>
						<crosstabTotalRowHeader>
							<cellContents backcolor="#005FB3" mode="Opaque">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<staticText>
									<reportElement uuid="c361512c-2bfd-470d-b8d0-2ff8d53ca275" x="0" y="0" width="210" height="20" forecolor="#FFFFFF"/>
									<textElement textAlignment="Center" verticalAlignment="Middle">
										<font fontName="Angsana New" size="14" isBold="true"/>
									</textElement>
									<text><![CDATA[รวมทั้งหมด]]></text>
								</staticText>
							</cellContents>
						</crosstabTotalRowHeader>
					</rowGroup>
					<rowGroup name="MEMBER_FLAG" width="70" totalPosition="End">
						<bucket class="java.lang.String">
							<bucketExpression><![CDATA[$F{MEMBER_FLAG} + $F{MEMBER_DESC}]]></bucketExpression>
						</bucket>
						<crosstabRowHeader>
							<cellContents backcolor="#FFFFFF" mode="Opaque">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<textField>
									<reportElement uuid="a837abec-f958-4597-b887-b74c946bc236" x="0" y="0" width="70" height="20"/>
									<textElement textAlignment="Center" verticalAlignment="Middle">
										<font fontName="Angsana New" size="14"/>
									</textElement>
									<textFieldExpression><![CDATA[$V{MEMBER_FLAG}.substring(1)]]></textFieldExpression>
								</textField>
							</cellContents>
						</crosstabRowHeader>
						<crosstabTotalRowHeader>
							<cellContents backcolor="#FFFFFF" mode="Opaque">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<staticText>
									<reportElement uuid="3d580c9e-e9ce-44da-ba8c-736719832954" x="0" y="0" width="70" height="20"/>
									<textElement textAlignment="Center" verticalAlignment="Middle">
										<font fontName="Angsana New" size="14" isBold="true"/>
									</textElement>
									<text><![CDATA[รวมประเภท]]></text>
								</staticText>
							</cellContents>
						</crosstabTotalRowHeader>
					</rowGroup>
					<columnGroup name="GROUP_DESC" height="20" totalPosition="End">
						<bucket class="java.lang.String">
							<bucketExpression><![CDATA[$F{GROUP_DESC}]]></bucketExpression>
						</bucket>
						<crosstabColumnHeader>
							<cellContents backcolor="#FFFFFF" mode="Opaque">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<textField>
									<reportElement uuid="067ba22b-0ba6-4e0c-9c86-08764f381837" x="0" y="0" width="70" height="20"/>
									<textElement textAlignment="Center" verticalAlignment="Middle">
										<font fontName="Angsana New"/>
									</textElement>
									<textFieldExpression><![CDATA[$V{GROUP_DESC}]]></textFieldExpression>
								</textField>
							</cellContents>
						</crosstabColumnHeader>
						<crosstabTotalColumnHeader>
							<cellContents backcolor="#FFFFFF" mode="Opaque">
								<box>
									<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
								</box>
								<staticText>
									<reportElement uuid="28161b1d-560f-4446-bac0-9bb459d0829a" x="0" y="0" width="50" height="20"/>
									<textElement textAlignment="Center" verticalAlignment="Middle">
										<font fontName="Angsana New" size="14" isBold="true"/>
									</textElement>
									<text><![CDATA[รวม]]></text>
								</staticText>
							</cellContents>
						</crosstabTotalColumnHeader>
					</columnGroup>
					<measure name="MEMBER_CNTMeasure" class="java.lang.Integer">
						<measureExpression><![CDATA[$F{MEMBER_CNT}]]></measureExpression>
					</measure>
					<measure name="MEMBER_CNT" class="java.lang.Integer" calculation="Sum">
						<measureExpression><![CDATA[$F{MEMBER_CNT}]]></measureExpression>
					</measure>
					<crosstabCell width="70" height="20">
						<cellContents backcolor="#FFFFFF" mode="Transparent">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="31b8e9d7-73d9-40b3-9f25-7b8243914912" x="0" y="0" width="70" height="20"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNTMeasure}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
					<crosstabCell width="70" height="20" rowTotalGroup="LOANTYPE_CODE">
						<cellContents backcolor="#005FB3" mode="Opaque">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="32a146f6-8a42-4cf9-b54b-e6e42f52c143" x="0" y="0" width="70" height="20" forecolor="#FFFFFF"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNT_LOANTYPE_CODE_ALL}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
					<crosstabCell width="50" height="20" columnTotalGroup="GROUP_DESC">
						<cellContents backcolor="#FFFFFF" mode="Opaque">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="d27b0560-7e3e-4e34-aee8-55bac6f9f132" x="0" y="0" width="50" height="20"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNT_GROUP_DESC_ALL}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
					<crosstabCell width="50" height="20" rowTotalGroup="LOANTYPE_CODE" columnTotalGroup="GROUP_DESC">
						<cellContents backcolor="#005FB3" mode="Opaque">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="0ce23ee5-7226-4ca4-857c-7571def4a387" x="0" y="0" width="50" height="20" forecolor="#FFFFFF"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNT_LOANTYPE_CODE_GROUP_DESC_ALL}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
					<crosstabCell width="70" height="20" rowTotalGroup="MEMBER_FLAG">
						<cellContents backcolor="#FFFFFF" mode="Opaque">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="95473acb-270a-4b32-8c0d-3df84e5fbbb2" x="0" y="0" width="70" height="20"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNT_MEMBER_FLAG_ALL}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
					<crosstabCell width="50" height="20" rowTotalGroup="MEMBER_FLAG" columnTotalGroup="GROUP_DESC">
						<cellContents backcolor="#FFFFFF" mode="Opaque">
							<box>
								<pen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
							</box>
							<textField>
								<reportElement uuid="ecbbd8e8-3deb-4820-ad66-f573710402fc" x="0" y="0" width="50" height="20"/>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Angsana New" size="14" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{MEMBER_CNT_MEMBER_FLAG_GROUP_DESC_ALL}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabCell>
				</crosstab>
			</band>
		</groupFooter>
	</group>
	<group name="status">
		<groupExpression><![CDATA[$F{MEMBER_FLAG}]]></groupExpression>
	</group>
	<group name="ages">
		<groupExpression><![CDATA[$F{GROUP_CODE}]]></groupExpression>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<pageHeader>
		<band height="46" splitType="Stretch">
			<textField>
				<reportElement uuid="48b58cd6-5ef1-4b48-957b-86b586949640" x="0" y="0" width="960" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Angsana New" size="14"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{COOP_NAME}]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<summary>
		<band height="40" splitType="Stretch"/>
	</summary>
</jasperReport>
